---
-   name: Add group docker
    become: true
    group: name=docker state=present

-   name: Add user to the docker group
    become: true
    user: name=vagrant shell=/bin/bash groups=docker append=yes
    register: user_task

# this will force Ansible to create new connection(s) so that changes in ssh
# settings will have effect (normally Ansible uses ControlPersist feature to
# reuse one connection for all tasks). Note that the path to the socket must
# be the same as what is configured in ansible.cfg.
- name: kill cached ssh connection
  local_action: >
    shell ssh -O stop {{ ansible_host|default(inventory_hostname) }} -o ControlPath=~/.ansible/cp/ansible-ssh-{{ ansible_host|default(inventory_hostname) }}-{{ ansible_port|default('22') }}-{{ ansible_ssh_user }}
  run_once: yes
  register: socket_removal
  failed_when: >
    socket_removal|failed
    and "No such file or directory" not in socket_removal.stderr

-   name: Flush handlers
    meta: flush_handlers

-   name: Enable the EPEL repository definitions.
    become: true
    yum: pkg=epel-release

#-   name: Downloading and enable the EPEL repository definitions.
#    become: true
#    action: command rpm -Uvh --replacepkgs http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-8.noarch.rpm

#-   name: Install python setup tools
#    become: true
#    yum: name=python-setuptools
#    tags: docker

#-   name: Install Pypi
#    become: true
#    easy_install: name=pip
#    tags: docker

-   name: Install docker-py
    become: true
    pip: name=docker-py
    tags: docker

-   name: Update docker repo
    become: true
    lineinfile:
      dest: /etc/yum.repos.d/docker.repo
      create: yes
      line: "{{ item }}"
    with_items:
      - "[dockerrepo]"
      - "name=Docker Repository"
      - "baseurl=https://yum.dockerproject.org/repo/main/centos/7/"
      - "enabled=1"
      - "gpgcheck=1"
      - "gpgkey=https://yum.dockerproject.org/gpg"

-   name: Install Docker
    become: true
    yum: pkg=docker-engine state=present

-   name: Start service
    become: true
    service: name=docker.service state=started

-   name: Make sure Docker is running
    service: name=docker state=running
    tags: docker

-   name: Add docker service to sysv runlevels
    become: true
    shell: systemctl enable docker

-   name: create caliveapicreator dir
    become: yes
    file: path=/opt/caliveapicreator state=directory

-   name: copy caliveapicreator folder using a work around
    unarchive: src="{{ playbook_dir }}/caliveapicreator.zip" dest=/opt/
    become: yes

-   name: build docker image caliveapicreator
    become: yes
    docker_image:
      path: /opt/caliveapicreator/
      name: caliveapicreator


-   name: create dealmaker dir
    become: yes
    file: path=/opt/dealmaker state=directory

-   name: copy dealmaker folder using a work around
    unarchive: src="{{ playbook_dir }}/dealmaker.zip" dest=/opt/
    become: yes

-   name: build docker image dealmaker
    become: yes
    docker_image:
      path: /opt/dealmaker/
      name: dealmaker
